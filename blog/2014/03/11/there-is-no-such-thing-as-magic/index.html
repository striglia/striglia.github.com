
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>There is no such thing as magic - Locally Optimal</title>
  <meta name="author" content="Scott Triglia">

  
  <meta name="description" content="Do you know my favorite fact about programming? In the end, everything is build from code and you can understand it all &#8211; there is absolutely &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://striglia.github.com/blog/2014/03/11/there-is-no-such-thing-as-magic/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Locally Optimal" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35190779-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Locally Optimal</a></h1>
  
    <h2>Hill climbing in SF</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:striglia.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder=""/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">There Is No Such Thing as Magic</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-11T22:43:00-07:00" pubdate data-updated="true">Mar 11<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Do you know my favorite fact about programming? In the end, everything is build from code and you can understand it all &#8211; there is absolutely no magic. With enough effort, almost everything you interact with can be dug into, demystified, and explained. I know I often interact with various tools I use as if they were black boxes, either for lack of time, lack of interest, or a fear that I wouldn&#8217;t understand them if I tried. But let&#8217;s fight back against that.</p>

<p>So for this post, let&#8217;s understand what&#8217;s going on with python&#8217;s <a href="http://www.virtualenv.org/">virtualenv package</a>.</p>

<!-- more -->


<h2>The Basics</h2>

<p>Let&#8217;s start out simple &#8211; the purpose and use of virtualenv. Stealing directly from the project&#8217;s homepage, &#8220;virtualenv is a tool to create isolated Python environments.&#8221; Well great&#8230;what good is that?</p>

<h3>A little backstory</h3>

<p>I&#8217;ll explain by virtue of a story about my travails with scipy. If you don&#8217;t know, installing scipy/numpy on OS X has historically been&#8230;challenging. Numerous system-level dependencies, old versions of numpy pre-installed on the machine both complicate what is already a non-trivial installation procedure. This leads to a ton of posts like <a href="http://stackoverflow.com/questions/11517164/scipy-numpy-matplotlib-troubles-on-osx">this</a> or <a href="http://penandpants.com/2012/02/24/install-python/">this</a> and even extensive <a href="http://www.thisisthegreenroom.com/2011/installing-python-numpy-scipy-matplotlib-and-ipython-on-lion/">step-by-step guides</a>. Although scipy suffers from some complications surrounding required non-python bits (like fortran compilers), the most frequent problem I&#8217;ve had installing is simply having conflicting versions of numpy installed.</p>

<p>That brings us to Virtualenv, and its use case. Macs come helpfully pre-installed with an old and unhelpful version of numpy.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python -c <span class="s1">&#39;import numpy; print numpy; print numpy.__version__&#39;</span>
</span><span class='line'>&lt;module <span class="s1">&#39;numpy&#39;</span> from <span class="s1">&#39;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/numpy/__init__.pyc&#39;</span>&gt;
</span><span class='line'>1.5.1
</span></code></pre></td></tr></table></div></figure>


<p>Well that won&#8217;t work well with my hope to use the (very cool) data analysis library <code>pandas</code>. In fact, the <a href="http://pandas.pydata.org/pandas-docs/stable/install.html">pandas installation page</a> kindly points out that it requires numpy 1.6.1 or higher! How can we install pandas without changing the system installed version of numpy? Enter virtualenv.</p>

<h3>Our very first virtualenv</h3>

<p>I promised I&#8217;d start out with a quick example, so let&#8217;s show how virtualenv solves our little scipy snafu in a pinch.</p>

<p>Virtualenvs are their own little world &#8211; by default they are entirely isolated from your system installed python packages. First lets install virtualenv (the last thing we&#8217;ll need to install globally!) and set up a sample env.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> ~  <span class="nv">$ </span>sudo pip install virtualenv
</span><span class='line'>Downloading/unpacking virtualenv
</span><span class='line'>  Running setup.py egg_info <span class="k">for </span>package virtualenv
</span><span class='line'>
</span><span class='line'>    warning: no files found matching <span class="s1">&#39;*.egg&#39;</span> under directory <span class="s1">&#39;virtualenv_support&#39;</span>
</span><span class='line'>    warning: no previously-included files matching <span class="s1">&#39;*&#39;</span> found under directory <span class="s1">&#39;docs/_templates&#39;</span>
</span><span class='line'>    warning: no previously-included files matching <span class="s1">&#39;*&#39;</span> found under directory <span class="s1">&#39;docs/_build&#39;</span>
</span><span class='line'>Installing collected packages: virtualenv
</span><span class='line'>  Running setup.py install <span class="k">for </span>virtualenv
</span><span class='line'>
</span><span class='line'>    warning: no files found matching <span class="s1">&#39;*.egg&#39;</span> under directory <span class="s1">&#39;virtualenv_support&#39;</span>
</span><span class='line'>    warning: no previously-included files matching <span class="s1">&#39;*&#39;</span> found under directory <span class="s1">&#39;docs/_templates&#39;</span>
</span><span class='line'>    warning: no previously-included files matching <span class="s1">&#39;*&#39;</span> found under directory <span class="s1">&#39;docs/_build&#39;</span>
</span><span class='line'>    Installing virtualenv script to /usr/local/bin
</span><span class='line'>    Installing virtualenv-2.7 script to /usr/local/bin
</span><span class='line'>Successfully installed virtualenv
</span><span class='line'>Cleaning up...
</span><span class='line'>~  <span class="nv">$ </span>virtualenv my_first_env
</span><span class='line'>New python executable in my_first_env/bin/python
</span><span class='line'>Installing Setuptools..............................................................................................................................................................................................................................done.
</span><span class='line'>Installing Pip.....................................................................................................................................................................................................................................................................................................................................done.
</span><span class='line'>~  <span class="nv">$ </span><span class="nb">source </span>my_first_env/bin/activate
</span><span class='line'><span class="o">(</span>my_first_env<span class="o">)</span> ~  <span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;hello world&#39;</span>
</span><span class='line'>hello world
</span></code></pre></td></tr></table></div></figure>


<p>Excellent! We installed virtualenv on our system using pip, created a virtualenv called <code>my_first_env</code>, and finally activated it. This means that python is now entirely isolated from system packages. Let&#8217;s prove it to ourselves by trying to import some packages we know are installed on this machine.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>my_first_env<span class="o">)</span> ~  <span class="nv">$ </span>python -c <span class="s1">&#39;import pytz; print pytz&#39;</span>
</span><span class='line'>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class='line'>  File <span class="s2">&quot;&lt;string&gt;&quot;</span>, line 1, in &lt;module&gt;
</span><span class='line'>ImportError: No module named pytz
</span><span class='line'><span class="o">(</span>my_first_env<span class="o">)</span> ~  <span class="nv">$ </span>python -c <span class="s1">&#39;import numpy; print numpy&#39;</span>
</span><span class='line'>Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
</span><span class='line'>  File <span class="s2">&quot;&lt;string&gt;&quot;</span>, line 1, in &lt;module&gt;
</span><span class='line'>ImportError: No module named numpy
</span></code></pre></td></tr></table></div></figure>


<p>And we can also test the same commands outside our virtualenv to confirm they work!</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>my_first_env<span class="o">)</span> ~  <span class="nv">$ </span>deactivate
</span><span class='line'> ~  <span class="nv">$ </span>python -c <span class="s1">&#39;import pytz; print pytz&#39;</span>
</span><span class='line'>&lt;module <span class="s1">&#39;pytz&#39;</span> from <span class="s1">&#39;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pytz/__init__.pyc&#39;</span>&gt;
</span><span class='line'> ~  <span class="nv">$ </span><span class="nb">source </span>my_first_env/bin/activate
</span></code></pre></td></tr></table></div></figure>


<p>Interesting. And how about installing that fresh new package we had our eyes on?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">(</span>my_first_env<span class="o">)</span> ~  <span class="nv">$ </span>pip install pandas
</span><span class='line'>Downloading/unpacking pandas
</span><span class='line'>  Downloading pandas-0.12.0.tar.gz <span class="o">(</span>3.2MB<span class="o">)</span>: 3.2MB downloaded
</span><span class='line'>
</span><span class='line'>-----<span class="o">(</span>it continues <span class="k">for </span>a <span class="k">while </span>installing various dependencies<span class="o">)</span>-----
</span><span class='line'>
</span><span class='line'>Successfully installed pandas python-dateutil pytz six
</span><span class='line'>Cleaning up...
</span></code></pre></td></tr></table></div></figure>


<p>And there we go! We can now happily play around with all of the installed packages inside of our virtual environment and we did it without affecting any other users of this computer, or requiring global install privileges.</p>

<h2>Well that was magical</h2>

<p>If you&#8217;re anything like me, your natural first reaction to a new tool like this is to feel a little uncomfortable. You can go through the motions (perhaps copying from some tutorial you found on a blog) and hope things will still work, but there&#8217;s no real understanding of how this new tools works. Maybe you even resign yourself to never understanding something and just keep using it the way you were taught, effectively becoming a <a href="http://en.wikipedia.org/wiki/Cargo_cult_programming">cargo cult programmer</a>.</p>

<p>Avoiding that behavior is exactly the point of this blogpost, and I think it&#8217;s perhaps <strong>the</strong> most powerful skill for any programmer. Digging into an unfamiliar project and building a mental model of how it works is the essence of programming! If you truly understand how something is put together, you can modify it, improve it, or explain it with ease.</p>

<p>So for the rest of this post, let&#8217;s dig in and prove virtualenv isn&#8217;t magic. We will both be taking this journey together, as I&#8217;ve never dug into its guts either. So let&#8217;s see what we can figure out.</p>

<h2>Going to the source</h2>

<p>So lets crack open <code>virtualenv</code> and understand what&#8217;s actually happening.</p>

<p>There are three main scripts we keep calling to create, activate, and deactivate a virtualenv &#8211; <code>virtualenv</code>, <code>venv/bin/activate</code> and <code>deactivate</code>. Let&#8217;s deal with creating the environment with <code>virtualenv</code> before jumping into activation/deactivation.</p>

<h3>Creating a virtualenv</h3>

<p>Opening up the file at <code>which virtualenv</code> drops me into the source:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python                                                               </span>
</span><span class='line'><span class="c"># EASY-INSTALL-ENTRY-SCRIPT: &#39;virtualenv==1.10.1&#39;,&#39;console_scripts&#39;,&#39;virtualenv&#39;</span>
</span><span class='line'><span class="n">__requires__</span> <span class="o">=</span> <span class="s">&#39;virtualenv==1.10.1&#39;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">load_entry_point</span>
</span><span class='line'>
</span><span class='line'><span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
</span><span class='line'>   <span class="n">load_entry_point</span><span class="p">(</span><span class="s">&#39;virtualenv==1.10.1&#39;</span><span class="p">,</span> <span class="s">&#39;console_scripts&#39;</span><span class="p">,</span> <span class="s">&#39;virtualenv&#39;</span><span class="p">)()</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Well that&#8217;s not very helpful. Looks like running <code>virtualenv</code> is actually just executing this bit of code. Time to see if we can figure out what <code>load_entry_point</code> is and what it is actually calling.</p>

<p>A little googling later, we find <a href="http://stackoverflow.com/a/9615473">this SO post</a> on the subject. Looks like in nice python packages, entry points are defined in <code>setup.py</code> and automatically linked to runnable scripts at installation time. We can download the source from <a href="https://pypi.python.org/pypi/virtualenv">pypi</a> and take a look ourselves.</p>

<p>Sure enough, when we open up <code>setup.py</code> we see the entry_point dict we were promised:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">setup_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;entry_points&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;console_scripts&#39;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>            <span class="s">&#39;virtualenv=virtualenv:main&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&#39;virtualenv-</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">=virtualenv:main&#39;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>        <span class="p">],</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s">&#39;zip_safe&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;test_suite&#39;</span><span class="p">:</span> <span class="s">&#39;nose.collector&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;tests_require&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;nose&#39;</span><span class="p">,</span> <span class="s">&#39;Mock&#39;</span><span class="p">],</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Indeed they seem to be linking the runnable <code>virtualenv</code> python script to the <code>main</code> function of virtualenv.py. Let&#8217;s see what that looks like. The content of the main function appears to roughly follow these steps:</p>

<ul>
<li>Build an option parser with <code>optparse</code></li>
<li>Check if the script was called with the <code>--python</code> interpreter option and possibly exit.</li>
<li>Take actions based on various command line options</li>
<li>Call the <code>create_environment</code> method!</li>
</ul>


<p>Well now that last one sounds quite relevant! Here&#8217;s the full text of the create_environment method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">create_environment</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="n">site_packages</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">unzip_setuptools</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">prompt</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">search_dirs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">never_download</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
</span><span class='line'>                       <span class="n">no_setuptools</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">no_pip</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;                                                                                              </span>
</span><span class='line'><span class="sd">    Creates a new environment in ``home_dir``.                                                       </span>
</span><span class='line'><span class="sd">                                                                                                     </span>
</span><span class='line'><span class="sd">    If ``site_packages`` is true, then the global ``site-packages/``                                 </span>
</span><span class='line'><span class="sd">    directory will be on the path.                                                                   </span>
</span><span class='line'><span class="sd">                                                                                                     </span>
</span><span class='line'><span class="sd">    If ``clear`` is true (default False) then the environment will                                   </span>
</span><span class='line'><span class="sd">    first be cleared.                                                                                </span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">home_dir</span><span class="p">,</span> <span class="n">lib_dir</span><span class="p">,</span> <span class="n">inc_dir</span><span class="p">,</span> <span class="n">bin_dir</span> <span class="o">=</span> <span class="n">path_locations</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">py_executable</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">install_python</span><span class="p">(</span>
</span><span class='line'>        <span class="n">home_dir</span><span class="p">,</span> <span class="n">lib_dir</span><span class="p">,</span> <span class="n">inc_dir</span><span class="p">,</span> <span class="n">bin_dir</span><span class="p">,</span>
</span><span class='line'>        <span class="n">site_packages</span><span class="o">=</span><span class="n">site_packages</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="n">clear</span><span class="p">,</span> <span class="n">symlink</span><span class="o">=</span><span class="n">symlink</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">install_distutils</span><span class="p">(</span><span class="n">home_dir</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">no_setuptools</span><span class="p">:</span>
</span><span class='line'>        <span class="n">install_sdist</span><span class="p">(</span><span class="s">&#39;Setuptools&#39;</span><span class="p">,</span> <span class="s">&#39;setuptools-*.tar.gz&#39;</span><span class="p">,</span> <span class="n">py_executable</span><span class="p">,</span> <span class="n">search_dirs</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="ow">not</span> <span class="n">no_pip</span><span class="p">:</span>
</span><span class='line'>            <span class="n">install_sdist</span><span class="p">(</span><span class="s">&#39;Pip&#39;</span><span class="p">,</span> <span class="s">&#39;pip-*.tar.gz&#39;</span><span class="p">,</span> <span class="n">py_executable</span><span class="p">,</span> <span class="n">search_dirs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">install_activate</span><span class="p">(</span><span class="n">home_dir</span><span class="p">,</span> <span class="n">bin_dir</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we&#8217;re getting somewhere! It looks like the basic steps are:</p>

<ol>
<li>Get a bunch of path locations based on the <code>home_dir</code> path</li>
<li>Install python inside our environment and return a path to the executable</li>
<li>Install some subset of <code>distutils</code>, <code>setuptools</code> and <code>pip</code></li>
<li>Install the <code>activate</code> scripts into this new virtualenv</li>
</ol>


<p>And that&#8217;s the essence of what running <code>virtualenv</code> does: it defines paths for the interpreter, libraries and binaries; installs the interpreter and installation-related python packages; and it installs the <code>activate</code> script so you can activate it. And we now understand what goes into creating a new virtualenv.</p>

<h3>Activating and Deactivating</h3>

<p>So that leaves the question of what <code>activate</code> and <code>deactivate</code> are up to. We can inspect the activate script easily enough by running <code>vim my_first_env/bin/activate</code>.</p>

<p>The first thing we notice is that a bash function <code>deactivate</code> is defined immediately. We&#8217;ll get back to this later in this section, but this is actually the definition of the <code>deactivate</code> method we call to leave the virtualenv. The relevant lines are so brief, you might miss them entirely:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">_OLD_VIRTUAL_PATH</span><span class="o">=</span><span class="s2">&quot;$PATH&quot;</span>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;$VIRTUAL_ENV/bin:$PATH&quot;</span>
</span><span class='line'><span class="nb">export </span>PATH
</span></code></pre></td></tr></table></div></figure>


<p>Note that we&#8217;re saving the old <code>PATH</code> and making a new one, with our local virtualenv prepended! This means that the next time we run <code>python</code>, we&#8217;ll get the interpreter we installed into our virtualenv, which is pointed at all our own libraries instead of the default system-installed interpreter. With that in mind, let&#8217;s look at the <code>deactivate</code> function.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deactivate <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nb">unset </span>pydoc
</span><span class='line'>
</span><span class='line'>    <span class="c"># reset old environment variables                                           </span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$_OLD_VIRTUAL_PATH&quot;</span> <span class="o">]</span> ; <span class="k">then                                       </span>
</span><span class='line'><span class="k">        </span><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;$_OLD_VIRTUAL_PATH&quot;</span>
</span><span class='line'>        <span class="nb">export </span>PATH
</span><span class='line'>        <span class="nb">unset </span>_OLD_VIRTUAL_PATH
</span><span class='line'>    <span class="k">fi                                                                          </span>
</span><span class='line'><span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$_OLD_VIRTUAL_PYTHONHOME&quot;</span> <span class="o">]</span> ; <span class="k">then                                 </span>
</span><span class='line'><span class="k">        </span><span class="nv">PYTHONHOME</span><span class="o">=</span><span class="s2">&quot;$_OLD_VIRTUAL_PYTHONHOME&quot;</span>
</span><span class='line'>        <span class="nb">export </span>PYTHONHOME
</span><span class='line'>        <span class="nb">unset </span>_OLD_VIRTUAL_PYTHONHOME
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># This should detect bash and zsh, which have a hash command that must      </span>
</span><span class='line'>    <span class="c"># be called to get it to forget past commands.  Without forgetting          </span>
</span><span class='line'>    <span class="c"># past commands the $PATH changes we made may not be respected              </span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$BASH&quot;</span> -o -n <span class="s2">&quot;$ZSH_VERSION&quot;</span> <span class="o">]</span> ; <span class="k">then                               </span>
</span><span class='line'><span class="k">        </span><span class="nb">hash</span> -r 2&gt;/dev/null
</span><span class='line'>    <span class="k">fi                                                                          </span>
</span><span class='line'><span class="k">                                                                                </span>
</span><span class='line'><span class="k">    if</span> <span class="o">[</span> -n <span class="s2">&quot;$_OLD_VIRTUAL_PS1&quot;</span> <span class="o">]</span> ; <span class="k">then                                        </span>
</span><span class='line'><span class="k">        </span><span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;$_OLD_VIRTUAL_PS1&quot;</span>
</span><span class='line'>        <span class="nb">export </span>PS1
</span><span class='line'>        <span class="nb">unset </span>_OLD_VIRTUAL_PS1
</span><span class='line'>    <span class="k">fi                                                                          </span>
</span><span class='line'><span class="k">                                                                                </span>
</span><span class='line'><span class="k">    </span><span class="nb">unset </span>VIRTUAL_ENV
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> ! <span class="s2">&quot;$1&quot;</span> <span class="o">=</span> <span class="s2">&quot;nondestructive&quot;</span> <span class="o">]</span> ; <span class="k">then</span>
</span><span class='line'>    <span class="c"># Self destruct!                                                            </span>
</span><span class='line'>        <span class="nb">unset</span> -f deactivate
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The important part here is the resetting of old environment variables (notably <code>PATH</code>).</p>

<p>You can notice other details in this file, like the setting/unsetting of your <a href="http://www.cyberciti.biz/tips/howto-linux-unix-bash-shell-setup-prompt.html">shell prompt</a> to include the name of the currently active virtualenv.</p>

<p>And that&#8217;s it &#8211; you&#8217;ve uncovered the basics of how virtualenv works!</p>

<h2>Just the beginning</h2>

<p>Just like that, we&#8217;ve taken a nontrivial tool and pulled it apart into understandable pieces. I certainly didn&#8217;t understand every part of what we found immediately (and that&#8217;s perfectly okay and expected!), but through some persistent searching and effort, it all makes sense. And every time I go through this process with a new tool, I find myself understanding more and more of what is going on, and gaining greater familiarity with various python tools.</p>

<p>On the subject of virtualenv in particular, I&#8217;ve since discovered <a href="http://blip.tv/pycon-us-videos-2009-2010-2011/pycon-2011-reverse-engineering-ian-bicking-s-brain-inside-pip-and-virtualenv-4899496">this excellent overview of the its guts</a> from PyCon 2011. Take a look if you&#8217;re interested in even more detail on the subject (like why does using a particular python interpreter change where I look up system packages).</p>

<p>So go find something you don&#8217;t understand! I&#8217;ve been elbow deep in learning the various horrors of python packaging lately, so perhaps I&#8217;ll continue this series with a look into some aspect of that. Either way, I hope I&#8217;ve encouraged you to not be afraid of jumping into unfamiliar territory and transforming code from mysterious to understood.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Scott Triglia</span></span>

      








  


<time datetime="2014-03-11T22:43:00-07:00" pubdate data-updated="true">Mar 11<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/virtualenv/'>virtualenv</a>
  
</span>


    </p>
    
      <div class="sharing">
  <ul class="share-buttons">
    
    <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocallyoptimal.com&t=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&t=' + encodeURIComponent(document.URL)); return false;"><img src="/images/Facebook.png"></a></li>
    
    
    <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Flocallyoptimal.com&text=:%20http%3A%2F%2Flocallyoptimal.com&via=scott_triglia" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ':%20'  + encodeURIComponent(document.URL)); return false;"><img src="/images/Twitter.png"></a></li>
    
    
    <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Flocallyoptimal.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/Reddit.png"></a></li>
    
    <li><a href="https://getpocket.com/save?url=http%3A%2F%2Flocallyoptimal.com&title=" target="_blank" title="Add to Pocket" onclick="window.open('https://getpocket.com/save?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img src="/images/Pocket.png"></a></li>
  </ul>
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/10/22/coding-free-interview-tips/" title="Previous Post: Coding-Free Interview Tips">&laquo; Coding-Free Interview Tips</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/03/14/building-a-basic-package-pt-1-bare-bones/" title="Next Post: Building a basic package pt. 1: Bare Bones">Building a basic package pt. 1: Bare Bones &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
	<h1>About Me</h1>
	<div style="margin-top:10px; ">
		<img style class="left" height="120" width="120" src="http://i.imgur.com/vVsqL.jpg">
		<p>I writes codes at Yelp.</p>
	</div>
        <a href="http://twitter.com/scott_triglia" class="twitter-follow-button" data-show-count="false">Follow @scott_triglia</a>
</section>
<!-- Begin MailChimp Signup Form -->
<link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">
<div id="mc_embed_signup">
<form action="//locallyoptimal.us10.list-manage.com/subscribe/post?u=d3758fa7ff1fe8c1066912e42&amp;id=9fa41553a4" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
	<label for="mce-EMAIL">Subscribe to Locally Optimal</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="you@gmail.com" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_d3758fa7ff1fe8c1066912e42_9fa41553a4" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>

<!--End mc_embed_signup-->
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/06/04/notes-from-vanpyday-2016/">Notes from VanPyDay 2016</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/25/pyconau-field-notes/">PyconAU 2015 field notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/14/executable-python-scripts-via-entry-points/">Executable python scripts via entry points</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/14/building-a-basic-package-pt-1-bare-bones/">Building a basic package pt. 1: Bare Bones</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/03/11/there-is-no-such-thing-as-magic/">There is no such thing as magic</a>
      </li>
    
  </ul>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Scott Triglia -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'locallyoptimal';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://striglia.github.com/blog/2014/03/11/there-is-no-such-thing-as-magic/';
        var disqus_url = 'http://striglia.github.com/blog/2014/03/11/there-is-no-such-thing-as-magic/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
